import ccxt
import pandas as pd
import numpy as np
import asyncio
from telegram import Bot
from telegram.error import TelegramError
import mplfinance as mpf

def fetch_binance_data(symbol, timeframe='1h', limit=100):
    try:
        binance = ccxt.binance()
        ohlcv = binance.fetch_ohlcv(symbol, timeframe=timeframe, limit=limit)
        data = pd.DataFrame(ohlcv, columns=['timestamp', 'open', 'high', 'low', 'close', 'volume'])
        data['timestamp'] = pd.to_datetime(data['timestamp'], unit='ms')
        data.set_index('timestamp', inplace=True)
        return data
    except Exception as e:
        print(f"Error fetching data for {symbol}: {e}")
        return pd.DataFrame()

def calculate_vwma(data, period):
    vwma = (data['close'] * data['volume']).rolling(window=period).sum() / data['volume'].rolling(window=period).sum()
    return vwma

def detect_vwma_crossover(data, short_period, long_period):
    data['vwma_short'] = calculate_vwma(data, short_period)
    data['vwma_long'] = calculate_vwma(data, long_period)
    
    data['crossover'] = (data['vwma_short'] > data['vwma_long']).astype(int).diff()
    crossovers = data[data['crossover'] == 1]  # Detect where short-term VWMA crosses above long-term VWMA
    
    return crossovers

def plot_vwma(data, crossovers, symbol, filename):
    # Plot candlestick chart with VWMAs and crossover points
    apds = [
        mpf.make_addplot(data['vwma_short'], color='orange', linestyle='--'),
        mpf.make_addplot(data['vwma_long'], color='purple', linestyle='--'),
        mpf.make_addplot(crossovers['close'], type='scatter', markersize=100, marker='x', color='red')
    ]
    mpf.plot(data, type='candle', addplot=apds, title=f'VWMA Crossover Detection for {symbol}', style='yahoo', savefig=filename)

async def send_image_to_telegram(filename, token, chat_id):
    bot = Bot(token=token)
    try:
        with open(filename, 'rb') as photo:
            await bot.send_photo(chat_id=chat_id, photo=photo)
    except TelegramError as e:
        print(f"Error sending image to Telegram: {e}")

async def process_symbol(symbol, timeframe, short_period, long_period, token, chat_id):
    data = fetch_binance_data(symbol, timeframe)
    if data.empty:
        print(f"No data fetched for {symbol}.")
        return

    crossovers = detect_vwma_crossover(data, short_period, long_period)
    filename = f'{symbol.replace("/", "_")}_vwma_crossover.png'
    plot_vwma(data, crossovers, symbol, filename)
    
    await send_image_to_telegram(filename, token, chat_id)

async def main():
    symbols = ['BTC/USDT', 'ETH/USDT', 'BNB/USDT']  # Add more pairs as needed
    timeframe = '1h'
    token = '7124807761:AAFeEIuLTN1VzLyunmVU4m-uEcLhaRQLN_Y'  # Replace with your actual token
    chat_id = '1385370555'  # Replace with your actual chat ID

    short_period = 20
    long_period = 50

    tasks = [process_symbol(symbol, timeframe, short_period, long_period, token, chat_id) for symbol in symbols]
    await asyncio.gather(*tasks)

if __name__ == "__main__":
    asyncio.run(main())